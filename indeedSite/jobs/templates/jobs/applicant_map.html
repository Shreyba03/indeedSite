{% extends "base.html" %}

{% block title %}IndeedLite - Find Your Next Career Opportunity{% endblock %}

{% block content %}
  <!-- Main Content -->
  <div class="container mt-4">
    <!-- Job Info Card -->
    <div class="job-info">
      <h5><i class="fas fa-briefcase me-2"></i>{{ job.title }}</h5>
      <p><i class="fas fa-building me-2"></i>{{ job.company }}</p>
      <p><i class="fas fa-map-marker-alt me-2"></i>{{ job.location }}</p>
    </div>

    <!-- Statistics -->
    <div class="stats-container">
      <div class="stat-card">
        <h6><i class="fas fa-users me-1"></i>Total Applicants</h6>
        <div class="stat-value" id="totalApplicants">0</div>
      </div>
      <div class="stat-card">
        <h6><i class="fas fa-map-marked-alt me-1"></i>With Location Data</h6>
        <div class="stat-value" id="mappedApplicants">0</div>
      </div>
      <div class="stat-card">
        <h6><i class="fas fa-layer-group me-1"></i>Location Clusters</h6>
        <div class="stat-value" id="clusterCount">0</div>
      </div>
    </div>

    <!-- Map Controls -->
    <div class="map-controls">
      <h2>
        <i class="fas fa-map-marked-alt me-2"></i>
        Applicant Location Map
      </h2>
      
      <!-- Map Info -->
      <div class="map-info">
        <h5><i class="fas fa-info-circle me-2"></i>About This Map</h5>
        <p>This map shows where your applicants are located. Markers are automatically clustered for better visualization. Click on clusters to zoom in and see individual applicants.</p>
      </div>
      
      <div style="text-align: center; margin-top: 1rem;">
        <a class="btn btn-secondary" href="{% url 'job_detail' job.id %}">
          <i class="fas fa-arrow-left"></i>
          Back to Job Details
        </a>
        <a class="btn btn-primary" href="{% url 'recommended_users' job.id %}">
          <i class="fas fa-user-check"></i>
          View Recommended Candidates
        </a>
      </div>
    </div>
    
    <!-- Applicant Count Display -->
    <div class="applicant-count" id="applicantCount">
      <i class="fas fa-users me-2"></i>
      Loading applicant locations...
    </div>
    
    <!-- Map Container -->
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Leaflet MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Initialize map centered on US
    const map = L.map('map').setView([39.8283, -98.5795], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Create marker cluster group
    const markers = L.markerClusterGroup({
      maxClusterRadius: 80,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: true,
      zoomToBoundsOnClick: true,
      iconCreateFunction: function(cluster) {
        const count = cluster.getChildCount();
        let size = 'small';
        if (count >= 10) {
          size = 'large';
        } else if (count >= 5) {
          size = 'medium';
        }
        return L.divIcon({
          html: '<div><span>' + count + '</span></div>',
          className: 'marker-cluster marker-cluster-' + size,
          iconSize: L.point(40, 40)
        });
      }
    });

    // Add job location marker if available
    {% if job.latitude and job.longitude %}
      const jobIcon = L.divIcon({
        html: '<i class="fas fa-briefcase" style="color: #B3A369; font-size: 24px;"></i>',
        className: 'job-location-icon',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });

      L.marker([{{ job.latitude }}, {{ job.longitude }}], { icon: jobIcon })
        .addTo(map)
        .bindPopup('<div class="applicant-popup"><h6><i class="fas fa-briefcase me-1"></i>Job Location</h6><p><strong>{{ job.location }}</strong></p></div>');
    {% endif %}

    // UI elements
    const applicantCount = document.getElementById('applicantCount');
    const totalApplicants = document.getElementById('totalApplicants');
    const mappedApplicants = document.getElementById('mappedApplicants');
    const clusterCount = document.getElementById('clusterCount');

    // Load applicants from server
    function loadApplicants() {
      const url = "{% url 'applicant_map_data' job.id %}";

      fetch(url)
        .then(response => response.json())
        .then(data => {
          const total = data.length;
          totalApplicants.textContent = total;
          mappedApplicants.textContent = total;
          
          applicantCount.innerHTML = `<i class="fas fa-users me-2"></i>Showing ${total} applicant${total !== 1 ? 's' : ''} with location data`;
          
          if (total === 0) {
            applicantCount.innerHTML = '<i class="fas fa-info-circle me-2"></i>No applicants with location data yet';
            return;
          }

          const bounds = [];
          
          data.forEach(applicant => {
            if (applicant.latitude && applicant.longitude) {
              // Determine status class
              let statusClass = 'status-applied';
              const status = applicant.status.toLowerCase();
              if (status.includes('review')) statusClass = 'status-under-review';
              else if (status.includes('interview')) statusClass = 'status-interview';
              else if (status.includes('rejected')) statusClass = 'status-rejected';
              else if (status.includes('accepted')) statusClass = 'status-accepted';

              const popupContent = `
                <div class="applicant-popup">
                  <h6><i class="fas fa-user me-1"></i>${applicant.username}</h6>
                  <p><strong><i class="fas fa-heading me-1"></i>${applicant.headline}</strong></p>
                  <p><i class="fas fa-map-marker-alt me-1"></i>${applicant.location}</p>
                  <p><i class="fas fa-calendar me-1"></i>Applied: ${applicant.applied_at}</p>
                  <p style="margin-top: 0.5rem;">
                    <span class="status-badge ${statusClass}">
                      ${applicant.status}
                    </span>
                  </p>
                  <div style="text-align: center; margin-top: 0.75rem;">
                    <a href="/jobs/profile/${applicant.id}/" class="btn btn-sm" style="background-color: #003057; color: white; text-decoration: none; padding: 0.375rem 0.75rem; border-radius: 0.25rem; font-size: 0.875rem;">
                      <i class="fas fa-eye me-1"></i>View Profile
                    </a>
                  </div>
                </div>
              `;
              
              const marker = L.marker([applicant.latitude, applicant.longitude])
                .bindPopup(popupContent);
              
              markers.addLayer(marker);
              bounds.push([applicant.latitude, applicant.longitude]);
            }
          });

          // Add marker cluster to map
          map.addLayer(markers);

          clusterCount.textContent = Math.ceil(total / 3);

          if (bounds.length > 0) {
            map.fitBounds(bounds, { padding: [50, 50] });
          }

          map.on('zoomend', function() {
            const visibleClusters = document.querySelectorAll('.marker-cluster').length;
            clusterCount.textContent = visibleClusters || Math.ceil(total / 3);
          });
        })
        .catch(error => {
          console.error('Error loading applicants:', error);
          applicantCount.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error loading applicant data';
        });
    }

    // Initial load of applicants
    loadApplicants();
  </script>
{% block content %}

