{% extends "base.html" %}

{% block title %}Applicant Locations - {{ job.title }} - IndeedLite{% endblock %}

{% block content %}

{% load static %}

<!-- Custom CSS for this page -->
<style>
  .map-controls {
    background: var(--card-bg);
    padding: 1.5rem;
    box-shadow: var(--gt-shadow-md);
    margin-bottom: 1rem;
    border-radius: 1rem;
    border: 2px solid var(--gt-navy);
  }

  .map-controls h2 {
    margin-top: 0;
    text-align: center;
    color: var(--gt-navy);
    font-weight: 700;
  }

  .job-info {
    background: linear-gradient(135deg, #003057 0%, #00457C 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    box-shadow: var(--gt-shadow-md);
  }

  .job-info p {
    margin: 0.25rem 0;
    opacity: 0.9;
  }

  .stats-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .stat-card {
    flex: 1;
    min-width: 200px;
    background: white;
    padding: 1rem;
    border-radius: 0.5rem;
    border-left: 4px solid var(--gt-gold);
    box-shadow: var(--gt-shadow-sm);
  }

  .stat-card h6 {
    color: var(--gt-navy);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
  }

  .stat-card .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gt-gold);
  }

  #map {
    height: 70vh;
    width: 100%;
    cursor: default;
    border-radius: 1rem;
    border: 2px solid var(--gt-navy);
    box-shadow: var(--gt-shadow-lg);
  }

  .applicant-count {
    text-align: center;
    padding: 1rem;
    font-weight: 600;
    background-color: var(--gt-navy);
    color: var(--gt-white);
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }

  .map-info {
    background: var(--card-bg);
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    border: 2px solid var(--gt-gold);
  }

  .marker-cluster-small div {
    background-color: rgba(179, 163, 105, 0.8);
    color: white;
    font-weight: bold;
  }

  .marker-cluster-medium div {
    background-color: rgba(0, 48, 87, 0.8);
    color: white;
  }

  .marker-cluster-large div {
    background-color: rgba(200, 16, 46, 0.8);
    color: white;
  }

  @media (max-width: 768px) {
    .stats-container { flex-direction: column; }
    #map { height: 60vh; }
  }
</style>

<!-- Job Info Section -->
<div class="container mt-4">

  <div class="job-info">
    <h5><i class="fas fa-briefcase me-2"></i>{{ job.title }}</h5>
    <p><i class="fas fa-building me-2"></i>{{ job.company }}</p>
    <p><i class="fas fa-map-marker-alt me-2"></i>{{ job.location }}</p>
  </div>

  <!-- Statistics -->
  <div class="stats-container">
    <div class="stat-card">
      <h6><i class="fas fa-users me-1"></i>Total Applicants</h6>
      <div class="stat-value" id="totalApplicants">0</div>
    </div>
    <div class="stat-card">
      <h6><i class="fas fa-map-marked-alt me-1"></i>With Location Data</h6>
      <div class="stat-value" id="mappedApplicants">0</div>
    </div>
    <div class="stat-card">
      <h6><i class="fas fa-layer-group me-1"></i>Location Clusters</h6>
      <div class="stat-value" id="clusterCount">0</div>
    </div>
  </div>

  <!-- Map Controls -->
  <div class="map-controls">
    <h2><i class="fas fa-map-marked-alt me-2"></i>Applicant Location Map</h2>

    <!-- Dropdown restored -->
    {% if recruiter_jobs %}
    <div class="mt-3">
      <label class="form-label fw-bold text-dark">
        <i class="fas fa-briefcase me-1"></i>Select Job
      </label>
      <select id="jobSwitcher" class="form-select">
        {% for j in recruiter_jobs %}
          <option value="{% url 'applicant_map' j.id %}" {% if j.id == job.id %}selected{% endif %}>
            {{ j.title }}
          </option>
        {% endfor %}
      </select>

      <script>
        document.getElementById("jobSwitcher").addEventListener("change", function() {
          window.location.href = this.value;
        });
      </script>
    </div>
    {% endif %}

    <div class="map-info mt-3">
      <h5><i class="fas fa-info-circle me-2"></i>About This Map</h5>
      <p>This map shows applicant locations using marker clustering for clarity.</p>
    </div>

    <div class="text-center mt-3">
      <a class="btn btn-secondary" href="{% url 'job_detail' job.id %}">
        <i class="fas fa-arrow-left"></i> Back to Job Details
      </a>
      <a class="btn btn-primary" href="{% url 'recommended_users' job.id %}">
        <i class="fas fa-user-check"></i> View Recommended Candidates
      </a>
    </div>

  </div>

  <div class="applicant-count" id="applicantCount">
    <i class="fas fa-users me-2"></i>Loading applicant locations...
  </div>

  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Page Script -->
<script>
  // Initialize map
  const map = L.map('map').setView([39.8283, -98.5795], 4);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // Add job location marker if available
  {% if job.latitude and job.longitude %}
    const jobIcon = L.divIcon({
      html: '<i class="fas fa-briefcase" style="color: #B3A369; font-size: 28px;"></i>',
      className: 'job-location-icon',
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });

    L.marker([{{ job.latitude }}, {{ job.longitude }}], { icon: jobIcon })
      .addTo(map)
      .bindPopup(`
        <div class="applicant-popup">
          <h6><i class="fas fa-briefcase me-1"></i>Job Location</h6>
          <p><strong>{{ job.location }}</strong></p>
        </div>
      `);
  {% endif %}

  const markers = L.markerClusterGroup({
    maxClusterRadius: 80,
    spiderfyOnMaxZoom: true,
    iconCreateFunction: cluster => {
      const count = cluster.getChildCount();
      let size = count >= 10 ? "large" : count >= 5 ? "medium" : "small";
      return L.divIcon({
        html: `<div><span>${count}</span></div>`,
        className: `marker-cluster marker-cluster-${size}`
      });
    }
  });

  const totalEl = document.getElementById('totalApplicants');
  const mappedEl = document.getElementById('mappedApplicants');
  const clusterEl = document.getElementById('clusterCount');

  fetch("{% url 'applicant_map_data' job.id %}")
    .then(res => res.json())
    .then(data => {
      totalEl.textContent = data.length;
      mappedEl.textContent = data.length;

      const coords = [];

      data.forEach(a => {
        if (a.latitude && a.longitude) {
          const marker = L.marker([a.latitude, a.longitude]);
          coords.push([a.latitude, a.longitude]);
          markers.addLayer(marker);
        }
      });

      map.addLayer(markers);

      clusterEl.textContent = Math.ceil(data.length / 3);

      if (coords.length > 0) {
        map.fitBounds(coords, { padding: [40, 40] });
      }
    });
</script>

{% endblock content %}